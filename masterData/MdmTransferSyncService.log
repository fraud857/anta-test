package com.datacyber.cyber.user.service.mdm;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.datacyber.cyber.user.config.MdmSyncConfig;
import com.datacyber.cyber.user.dto.mdm.MdmApiResponse;
import com.datacyber.cyber.user.dto.mdm.MdmTransferData;
import com.datacyber.cyber.user.dto.mdm.MdmUserSyncRequest;
import com.datacyber.cyber.user.dto.mdm.SyncResult;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;

/**
 * MDM调岗同步服务
 * 负责协调整个调岗同步流程，管理同步状态，实现增量同步逻辑
 */
@Service
@Slf4j
public class MdmTransferSyncService {

    @Autowired
    private MdmSyncConfig config;

    @Autowired
    private MdmApiClient mdmApiClient;

    @Autowired
    private TransferDataProcessor transferDataProcessor;

    private static final String LAST_SYNC_TIMESTAMP_KEY = "mdm:sync:transfer:last_timestamp";
    private static final String RATE_LIMIT_KEY = "transfer_sync";
    private static final String TRANSFER_API_PATH = "/anta/mdm/demdm-api/open/api/v2/selectApi/PDI_QUERY/1.0.0";

    /**
     * 执行完整的调岗同步流程
     *
     * @return 同步结果
     */
    public SyncResult executeSync() {
        SyncResult result = SyncResult.builder()
                .success(false)
                .totalProcessed(0)
                .build();

        // 记录同步开始时间
        String syncStartTimeStr = mdmApiClient.getCurrentTimestamp();
        result.setSyncTime(syncStartTimeStr);

        log.info("开始执行MDM调岗同步，同步时间: {}", syncStartTimeStr);

        try {
            // 1. 获取上次同步时间
            String lastSyncTime = mdmApiClient.getLastSyncTimestamp(LAST_SYNC_TIMESTAMP_KEY, 30);
            log.info("上次调岗同步时间: {}", lastSyncTime);

            // 2. 使用当前时间作为结束时间
            String currentTime = syncStartTimeStr;
            log.info("本次调岗同步结束时间: {}", currentTime);

            // 3. 分页获取数据
            String lastId = null;
            boolean hasMore = true;
            int totalProcessed = 0;
            int pageNumber = 1;

            while (hasMore) {
                log.info("开始获取调岗第{}页数据, lastId={}", pageNumber, lastId);

                // 调用API获取分页数据
                MdmApiResponse<MdmTransferData> response = fetchTransferDataWithRetry(
                        lastId,
                        lastSyncTime,
                        currentTime,
                        config.getBatchSize(),
                        pageNumber
                );

                // 检查响应
                if (response == null) {
                    throw new RuntimeException("API响应为空");
                }

                if (!"QUERY_SUCCESS".equalsIgnoreCase(response.getMessage())) {
                    throw new RuntimeException("API调用失败: " + response.getMessage() +
                            ", errorCode: " + response.getErrorCode());
                }

                // 4. 处理每页数据
                List<MdmTransferData> transferDataList = response.getData();
                if (!CollectionUtils.isEmpty(transferDataList)) {
                    log.info("调岗第{}页获取到{}条数据", pageNumber, transferDataList.size());
                    int processed = transferDataProcessor.processBatch(transferDataList);
                    totalProcessed += processed;
                    log.info("调岗第{}页处理完成，成功处理{}条数据", pageNumber, processed);
                } else {
                    log.info("调岗第{}页没有数据", pageNumber);
                }

                // 5. 检查是否还有下一页
                hasMore = !response.isLastPage();
                if (hasMore) {
                    lastId = response.getLastId();
                    pageNumber++;
                    log.info("还有下一页调岗数据，lastId={}, 下一页页码={}", lastId, pageNumber);
                } else {
                    log.info("已到达调岗数据最后一页");
                }
            }

            // 6. 同步成功后保存时间戳
            mdmApiClient.saveLastSyncTimestamp(LAST_SYNC_TIMESTAMP_KEY, syncStartTimeStr);

            result.setSuccess(true);
            result.setTotalProcessed(totalProcessed);
            log.info("MDM调岗同步完成，共处理{}页，成功处理{}条记录", pageNumber, totalProcessed);

        } catch (Exception e) {
            log.error("MDM调岗同步失败", e);
            result.setSuccess(false);
            result.setErrorMessage(e.getMessage());
        }

        return result;
    }

    /**
     * 带重试机制的获取调岗数据
     *
     * @param lastId              上一页的最后一条记录ID
     * @param lastUpdateDateStart 增量同步开始时间
     * @param lastUpdateDateEnd   增量同步结束时间
     * @param pageSize            每页大小
     * @param pageNumber          页码
     * @return MDM API响应
     */
    public MdmApiResponse<MdmTransferData> fetchTransferDataWithRetry(
            String lastId,
            String lastUpdateDateStart,
            String lastUpdateDateEnd,
            Integer pageSize,
            Integer pageNumber) {

        // 生成请求UUID
        String requestUuid = mdmApiClient.generateRequestUuid();

        // 构建请求体
        MdmUserSyncRequest.MdmDataFilter dataFilter = MdmUserSyncRequest.MdmDataFilter.builder()
                .lastUpdateDateStart(lastUpdateDateStart)
                .lastUpdateDateEnd(lastUpdateDateEnd)
                .build();

        // 判断是否为首页
        boolean isFirstPage = (lastId == null || lastId.trim().isEmpty());

        MdmUserSyncRequest request = MdmUserSyncRequest.builder()
                .lastId(isFirstPage ? "" : lastId)
                .formCode("ALL")
                .uuid(requestUuid)
                .page(String.valueOf(pageNumber))
                .pageSize(String.valueOf(pageSize))
                .data(dataFilter)
                .build();

        log.info("获取调岗数据（带重试）: uuid={}, lastId={}, page={}, pageSize={}, startTime={}, endTime={}",
                requestUuid, request.getLastId(), request.getPage(), pageSize,
                lastUpdateDateStart, lastUpdateDateEnd);

        // 构建完整的API URL
        String apiUrl = config.getApiBaseUrl() + TRANSFER_API_PATH;

        // 使用通用的带重试方法调用API，使用"transfer_sync"作为限流key
        MdmApiResponse rawResponse = mdmApiClient.callMdmApiWithRetry(apiUrl, request, MdmApiResponse.class, RATE_LIMIT_KEY);

        // 转换响应数据类型（FastJSON泛型反序列化问题）
        MdmApiResponse<MdmTransferData> typedResponse = convertResponse(rawResponse);

        return typedResponse;
    }

    /**
     * 转换API响应的数据类型
     * 解决FastJSON泛型反序列化时将对象解析为JSONObject的问题
     *
     * @param rawResponse 原始响应
     * @return 类型化的响应
     */
    private MdmApiResponse<MdmTransferData> convertResponse(MdmApiResponse rawResponse) {
        if (rawResponse == null) {
            return null;
        }

        MdmApiResponse<MdmTransferData> typedResponse = new MdmApiResponse<>();
        typedResponse.setUuid(rawResponse.getUuid());
        typedResponse.setMdmCode(rawResponse.getMdmCode());
        typedResponse.setResult(rawResponse.getResult());
        typedResponse.setMessage(rawResponse.getMessage());
        typedResponse.setErrorCode(rawResponse.getErrorCode());
        typedResponse.setLastPage(rawResponse.getLastPage());

        // 转换DATA列表
        if (rawResponse.getData() != null && !rawResponse.getData().isEmpty()) {
            List<MdmTransferData> transferDataList = new ArrayList<>();
            for (Object item : rawResponse.getData()) {
                if (item instanceof JSONObject) {
                    // 将JSONObject转换为MdmTransferData
                    MdmTransferData transferData = JSON.toJavaObject((JSONObject) item, MdmTransferData.class);
                    transferDataList.add(transferData);
                } else if (item instanceof MdmTransferData) {
                    // 如果已经是正确类型，直接添加
                    transferDataList.add((MdmTransferData) item);
                } else {
                    // 其他情况，尝试通过JSON字符串转换
                    String jsonStr = JSON.toJSONString(item);
                    MdmTransferData transferData = JSON.parseObject(jsonStr, MdmTransferData.class);
                    transferDataList.add(transferData);
                }
            }
            typedResponse.setData(transferDataList);
        }

        return typedResponse;
    }
}
